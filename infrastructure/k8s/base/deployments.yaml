apiVersion: v1
kind: Namespace
metadata:
  name: draymaster
  labels:
    app.kubernetes.io/name: draymaster
---
# ConfigMap for shared configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: draymaster-config
  namespace: draymaster
data:
  ENVIRONMENT: "production"
  LOG_LEVEL: "info"
  KAFKA_BROKERS: "kafka:9092"
  REDIS_HOST: "redis"
  REDIS_PORT: "6379"
---
# Order Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
  namespace: draymaster
  labels:
    app: order-service
    version: v1
spec:
  replicas: 3
  selector:
    matchLabels:
      app: order-service
  template:
    metadata:
      labels:
        app: order-service
        version: v1
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: draymaster-service
      containers:
        - name: order-service
          image: draymaster/order-service:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
            - name: grpc
              containerPort: 9090
          env:
            - name: SERVICE_NAME
              value: "order-service"
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: database-credentials
                  key: host
            - name: DB_PORT
              value: "5432"
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: database-credentials
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: database-credentials
                  key: password
            - name: DB_NAME
              value: "orders"
          envFrom:
            - configMapRef:
                name: draymaster-config
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 20
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
          volumeMounts:
            - name: config
              mountPath: /etc/config
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: order-service-config
---
apiVersion: v1
kind: Service
metadata:
  name: order-service
  namespace: draymaster
  labels:
    app: order-service
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8080
      targetPort: 8080
    - name: grpc
      port: 9090
      targetPort: 9090
  selector:
    app: order-service
---
# Dispatch Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dispatch-service
  namespace: draymaster
  labels:
    app: dispatch-service
    version: v1
spec:
  replicas: 3
  selector:
    matchLabels:
      app: dispatch-service
  template:
    metadata:
      labels:
        app: dispatch-service
        version: v1
    spec:
      serviceAccountName: draymaster-service
      containers:
        - name: dispatch-service
          image: draymaster/dispatch-service:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
            - name: grpc
              containerPort: 9090
          env:
            - name: SERVICE_NAME
              value: "dispatch-service"
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: database-credentials
                  key: host
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: database-credentials
                  key: password
            - name: DB_NAME
              value: "dispatch"
          envFrom:
            - configMapRef:
                name: draymaster-config
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 20
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: dispatch-service
  namespace: draymaster
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8080
      targetPort: 8080
    - name: grpc
      port: 9090
      targetPort: 9090
  selector:
    app: dispatch-service
---
# Tracking Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tracking-service
  namespace: draymaster
  labels:
    app: tracking-service
    version: v1
spec:
  replicas: 3
  selector:
    matchLabels:
      app: tracking-service
  template:
    metadata:
      labels:
        app: tracking-service
        version: v1
    spec:
      serviceAccountName: draymaster-service
      containers:
        - name: tracking-service
          image: draymaster/tracking-service:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
            - name: grpc
              containerPort: 9090
          env:
            - name: SERVICE_NAME
              value: "tracking-service"
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: timescale-credentials
                  key: host
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: timescale-credentials
                  key: password
            - name: DB_NAME
              value: "tracking"
          envFrom:
            - configMapRef:
                name: draymaster-config
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
---
apiVersion: v1
kind: Service
metadata:
  name: tracking-service
  namespace: draymaster
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8080
      targetPort: 8080
    - name: grpc
      port: 9090
      targetPort: 9090
  selector:
    app: tracking-service
---
# API Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: draymaster
  labels:
    app: api-gateway
    version: v1
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
        version: v1
    spec:
      serviceAccountName: draymaster-service
      containers:
        - name: api-gateway
          image: draymaster/api-gateway:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
          env:
            - name: SERVICE_NAME
              value: "api-gateway"
            - name: ORDER_SERVICE_ADDR
              value: "order-service:9090"
            - name: DISPATCH_SERVICE_ADDR
              value: "dispatch-service:9090"
            - name: TRACKING_SERVICE_ADDR
              value: "tracking-service:9090"
            - name: BILLING_SERVICE_ADDR
              value: "billing-service:9090"
            - name: DRIVER_SERVICE_ADDR
              value: "driver-service:9090"
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: jwt-secret
                  key: secret
          envFrom:
            - configMapRef:
                name: draymaster-config
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 15
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: draymaster
spec:
  type: LoadBalancer
  ports:
    - name: http
      port: 80
      targetPort: 8080
    - name: https
      port: 443
      targetPort: 8080
  selector:
    app: api-gateway
---
# Horizontal Pod Autoscaler for API Gateway
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: api-gateway-hpa
  namespace: draymaster
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: api-gateway
  minReplicas: 3
  maxReplicas: 20
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: draymaster-service
  namespace: draymaster
---
# Network Policy - Allow internal communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-internal
  namespace: draymaster
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: draymaster
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: draymaster
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              app: kafka
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              app: redis
